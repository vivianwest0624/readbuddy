<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ReadBuddyï½œæœ—è®€å¤¥ä¼´</title>
    <!-- Tailwind CDN for quick styling (Route A: zero-build) -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-50">
    <div id="root"></div>

    <!-- React 18 UMD + Babel (to run JSX directly in the browser) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      // ========================
      // ReadBuddyï½œæœ—è®€å¤¥ä¼´ (merged main + vocabulary, Route A)
      // ========================

      // ----- Constants -----
      const RATE_MIN = 0.25; // æ”¯æ´åˆ°è¶…æ…¢ 0.25Ã—ï¼ˆæ…¢é€Ÿ 2 å€ï¼‰
      const RATE_MAX = 2.0;
      const RATE_ABS_MAX = 2.5; // å®‰å…¨ä¸Šé™ï¼ˆä¸åŒç€è¦½å™¨å¯¦ä½œç•¥æœ‰å·®ç•°ï¼‰

      function App() {
        // ---------- Safe storage helpers (avoid SSR / privacy errors) ----------
        const storage = React.useMemo(
          () => ({
            get(key, fallback = "") {
              try {
                if (typeof localStorage === "undefined") return fallback;
                const v = localStorage.getItem(key);
                return v == null ? fallback : v;
              } catch (_) {
                return fallback;
              }
            },
            set(key, value) {
              try {
                if (typeof localStorage !== "undefined") localStorage.setItem(key, value);
              } catch (_) {}
            },
          }),
          []
        );

        // ---------- State ----------
        const [text, setText] = React.useState("");
        const [rate, setRate] = React.useState(() => {
          const saved = parseFloat(storage.get("tts_rate", "1.0"));
          return Number.isFinite(saved) ? saved : 1.0;
        });
        const [voices, setVoices] = React.useState([]);
        const [voiceURI, setVoiceURI] = React.useState(() => storage.get("tts_voiceURI", ""));
        const [status, setStatus] = React.useState("idle"); // idle | speaking | paused
        const [currentIndex, setCurrentIndex] = React.useState(-1);
        const [testRuns, setTestRuns] = React.useState(null);
        const queueRef = React.useRef([]); // utterances queue (article)
        const cancelledRef = React.useRef(false);

        // For syncing highlight into view (article preview)
        const chunkRefs = React.useRef([]);

        // Vocabulary state
        const [vocab, setVocab] = React.useState(() => {
          try {
            const raw = storage.get("tts_vocab", "[]");
            const arr = JSON.parse(raw);
            return Array.isArray(arr) ? arr : [];
          } catch {
            return [];
          }
        });
        const [termInput, setTermInput] = React.useState("");
        const [defInput, setDefInput] = React.useState("");
        const [repeatAll, setRepeatAll] = React.useState(2); // default: repeat each word 2x
        const [playDefToo, setPlayDefToo] = React.useState(false);

        // ---------- Env feature detection ----------
        const supported =
          typeof window !== "undefined" &&
          "speechSynthesis" in window &&
          typeof SpeechSynthesisUtterance !== "undefined";

        // ---------- Effects: load / persist ----------
        React.useEffect(() => {
          const savedText = storage.get("tts_text", "");
          if (savedText) setText(savedText);
        }, [storage]);

        React.useEffect(() => {
          storage.set("tts_rate", String(rate));
        }, [rate, storage]);

        React.useEffect(() => {
          if (voiceURI) storage.set("tts_voiceURI", voiceURI);
        }, [voiceURI, storage]);

        React.useEffect(() => {
          storage.set("tts_text", text);
        }, [text, storage]);

        React.useEffect(() => {
          try {
            storage.set("tts_vocab", JSON.stringify(vocab));
          } catch {}
        }, [vocab, storage]);

        // ---------- Voices loader ----------
        const loadVoices = React.useCallback(() => {
          if (!supported) return;
          const list = window.speechSynthesis.getVoices();
          setVoices(list);
          if (!voiceURI && list.length) {
            // Prefer zh-TW, zh-CN, then en-US, else first
            const prefer =
              list.find((v) => /zh-TW/i.test(v.lang)) ||
              list.find((v) => /zh-CN/i.test(v.lang)) ||
              list.find((v) => /en-US/i.test(v.lang)) ||
              list[0];
            if (prefer) setVoiceURI(prefer.voiceURI || prefer.name);
          }
        }, [supported, voiceURI]);

        React.useEffect(() => {
          if (!supported) return;
          loadVoices();
          // Some browsers populate voices asynchronously
          window.speechSynthesis.onvoiceschanged = loadVoices;
          return () => {
            if (window.speechSynthesis) window.speechSynthesis.onvoiceschanged = null;
          };
        }, [supported, loadVoices]);

        // ---------- Utils ----------
        function countWords(t) {
          // Basic estimate (works for English). For CJK, approximate by characters/2
          const latin = (t.match(/\S+/g) || []).length;
          const cjk = t.replace(/[\x00-\x7F]/g, "").length / 2;
          return Math.max(latin, Math.round(cjk));
        }

        function estimateDuration(txt, r) {
          const words = countWords(txt);
          const baseWPM = 160; // at rate = 1.0
          if (!words) return "0:00";
          const minutes = words / (baseWPM * Math.max(r, RATE_MIN));
          const totalSec = Math.ceil(minutes * 60);
          const mm = Math.floor(totalSec / 60);
          const ss = String(totalSec % 60).padStart(2, "0");
          return `${mm}:${ss}`;
        }

        function splitIntoChunks(t) {
          // Split by sentence enders and new lines, then chunk long sentences
          const parts = [];
          const tokens = t
            .split(/([ã€‚ï¼ï¼Ÿ!?.\n]+)/)
            .reduce((acc, cur) => {
              if (/[ã€‚ï¼ï¼Ÿ!?.\n]+/.test(cur) && acc.length) acc[acc.length - 1] += cur;
              else if (cur.trim()) acc.push(cur.trim());
              return acc;
            }, []);

          const MAX_LEN = 180; // keep short for stability across browsers
          for (const s of tokens) {
            if (s.length <= MAX_LEN) {
              parts.push(s);
            } else {
              // Soft split at spaces or punctuation
              let start = 0;
              while (start < s.length) {
                let end = Math.min(start + MAX_LEN, s.length);
                const slice = s.slice(start, end);
                const back = Math.max(
                  slice.lastIndexOf(" "),
                  slice.search(/[ï¼Œã€,;ï¼›]/) >= 0 ? slice.search(/[ï¼Œã€,;ï¼›](?!.*[ï¼Œã€,;ï¼›])/) : -1
                );
                if (back > 40) end = start + back + 1;
                parts.push(s.slice(start, end).trim());
                start = end;
              }
            }
          }
          return parts;
        }

        const getSelectedVoice = React.useCallback(() => {
          return voices.find((v) => (v.voiceURI || v.name) === voiceURI) || null;
        }, [voices, voiceURI]);

        // Chunks derived from current text (used for preview + TTS queue)
        const chunks = React.useMemo(() => splitIntoChunks(text.trim()), [text]);

        // Keep refs array length in sync
        React.useEffect(() => {
          chunkRefs.current = chunks.map((_, i) => chunkRefs.current[i] || React.createRef());
        }, [chunks.length]);

        // Auto scroll active chunk into view
        React.useEffect(() => {
          if (currentIndex < 0) return;
          const el = chunkRefs.current[currentIndex]?.current;
          if (el && typeof el.scrollIntoView === "function") {
            el.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }, [currentIndex]);

        // ---------- TTS controls (article) ----------
        function cancelAll() {
          if (!supported) return;
          cancelledRef.current = true;
          window.speechSynthesis.cancel();
          queueRef.current = [];
          setStatus("idle");
          setCurrentIndex(-1);
        }

        function speakFromIndex(startIndex = 0) {
          if (!supported || !text.trim()) return;
          cancelAll();
          cancelledRef.current = false;

          // Use current chunks to keep highlight in sync
          queueRef.current = chunks;

          const voice = getSelectedVoice();

          const speakChunk = (i) => {
            if (cancelledRef.current) return;
            if (i >= queueRef.current.length) {
              setStatus("idle");
              setCurrentIndex(-1);
              return;
            }
            const utter = new SpeechSynthesisUtterance(queueRef.current[i]);
            if (voice) utter.voice = voice;
            utter.rate = Math.min(Math.max(rate, RATE_MIN), RATE_ABS_MAX);
            utter.pitch = 1.0;

            utter.onstart = () => {
              setStatus("speaking");
              setCurrentIndex(i);
            };
            utter.onend = () => {
              setTimeout(() => speakChunk(i + 1), 50);
            };
            utter.onerror = () => {
              setTimeout(() => speakChunk(i + 1), 50);
            };

            window.speechSynthesis.speak(utter);
          };

          speakChunk(startIndex);
        }

        function speak() {
          speakFromIndex(0);
        }

        function pause() {
          if (!supported) return;
          window.speechSynthesis.pause();
          setStatus("paused");
        }

        function resume() {
          if (!supported) return;
          window.speechSynthesis.resume();
          setStatus("speaking");
        }

        // ---------- TTS helpers (vocabulary) ----------
        function speakTextsSequence(texts) {
          if (!supported || !texts.length) return;
          cancelAll();
          cancelledRef.current = false;
          const voice = getSelectedVoice();
          let i = -1;

        	const next = () => {
            if (cancelledRef.current) return;
            i += 1;
            if (i >= texts.length) {
              setStatus("idle");
              return;
            }
            const u = new SpeechSynthesisUtterance(texts[i]);
            if (voice) u.voice = voice;
            u.rate = Math.min(Math.max(rate, RATE_MIN), RATE_ABS_MAX);
            u.pitch = 1.0;
            u.onstart = () => {
              setStatus("speaking");
              setCurrentIndex(-1); // not tied to article highlight
            };
            u.onend = () => setTimeout(next, 120);
            u.onerror = () => setTimeout(next, 120);
            window.speechSynthesis.speak(u);
          };

          next();
        }

        function playWord(term, times = 3, withDefinition = false, definition = "") {
          const texts = [];
          for (let i = 0; i < times; i++) {
            texts.push(term);
            if (withDefinition && definition) texts.push(definition);
          }
          speakTextsSequence(texts);
        }

        function playAllWords(times = repeatAll, withDefinition = playDefToo) {
          const texts = [];
          vocab.forEach((it) => {
            for (let i = 0; i < times; i++) {
              texts.push(it.term);
              if (withDefinition && it.definition) texts.push(it.definition);
            }
          });
          speakTextsSequence(texts);
        }

        // ---------- Vocab utils (pure) ----------
        function normalizeTerm(t) {
          return (t || "").trim();
        }

        function addVocab(term, definition) {
          const t = normalizeTerm(term);
          const d = (definition || "").trim();
          if (!t) return false;
          setVocab((prev) => {
            const exists = prev.some((x) => x.term.toLowerCase() === t.toLowerCase());
            if (exists) {
              // update definition if provided
              return prev.map((x) => (x.term.toLowerCase() === t.toLowerCase() ? { ...x, definition: d || x.definition } : x));
            }
            return [...prev, { id: Date.now() + Math.random().toString(36).slice(2), term: t, definition: d }];
          });
          return true;
        }

        function removeVocab(id) {
          setVocab((prev) => prev.filter((x) => x.id !== id));
        }

        // ---------- Tests (pure functions only) ----------
        function runTests() {
          const results = [];
          // Existing tests (article functions)
          const chunks1 = splitIntoChunks("Hello world. How are you?");
          results.push({
            name: "splitIntoChunks basic EN",
            pass: chunks1.length === 2 && /[\.!?]$/.test(chunks1[0]) && /[\.!?]$/.test(chunks1[1]),
            info: JSON.stringify(chunks1),
          });

          const dur = estimateDuration("one two three four five six", 1.0);
          results.push({ name: "estimateDuration format", pass: /^\d+:\d{2}$/.test(dur), info: dur });

          const cwEn = countWords("hello world");
          results.push({ name: "countWords EN", pass: cwEn === 2, info: String(cwEn) });

          const cwCjk = countWords("ä½ å¥½ä¸–ç•Œ");
          results.push({ name: "countWords CJK approx", pass: cwCjk >= 2, info: String(cwCjk) });

          results.push({ name: "estimateDuration empty", pass: estimateDuration("", 1.0) === "0:00", info: estimateDuration("", 1.0) });

          const chunks2 = splitIntoChunks("ç¬¬ä¸€æ®µ\nç¬¬äºŒæ®µ\nç¬¬ä¸‰æ®µ");
          results.push({ name: "splitIntoChunks newline paragraphs", pass: chunks2.length === 3, info: JSON.stringify(chunks2) });

          // New tests for vocab helpers
          results.push({ name: "normalizeTerm trims", pass: normalizeTerm("  apple  ") === "apple", info: normalizeTerm("  apple  ") });

          // addVocab dedupe by term (case-insensitive)
          const localAdd = (arr, term, def) => {
            const t = (term || '').trim();
            const d = (def || '').trim();
            const exists = arr.some((x) => x.term.toLowerCase() === t.toLowerCase());
            return exists ? arr.map((x) => (x.term.toLowerCase() === t.toLowerCase() ? { ...x, definition: d || x.definition } : x)) : [...arr, { id: 'x', term: t, definition: d }];
          };
          let acc = [];
          acc = localAdd(acc, 'Apple', 'è˜‹æœ');
          acc = localAdd(acc, 'apple', 'è˜‹æœæ°´æœ');
          results.push({ name: "addVocab dedupe update def", pass: acc.length === 1 && /è˜‹æœæ°´æœ|è˜‹æœ/.test(acc[0].definition), info: JSON.stringify(acc) });

          setTestRuns(results);
        }

        // ---------- Derived ----------
        const isSpeaking = status === "speaking";
        const isPaused = status === "paused";
        const est = estimateDuration(text, rate);
        const selectedVoice = getSelectedVoice();

        const sampleZh = "ä½ å¥½ï¼é€™æ˜¯ä¸€å€‹æ–‡å­—è½‰èªéŸ³çš„ç¤ºä¾‹ã€‚ä½ å¯ä»¥èª¿æ•´èªé€Ÿï¼Œé¸æ“‡ä¸åŒçš„è²éŸ³ï¼Œç„¶å¾ŒæŒ‰ä¸‹æ’­æ”¾ã€‚ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼";
        const sampleEn = "Hello! This is a text-to-speech demo. You can adjust the speaking rate, choose a different voice, and then press play. Enjoy!";

        // ---------- UI ----------
        return (
          <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-800">
            <div className="max-w-6xl mx-auto p-6">
              <header className="flex items-center justify-between mb-6">
                <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">ReadBuddyï½œæœ—è®€å¤¥ä¼´</h1>
                <div className="text-sm text-slate-500">Web Speech API TTS</div>
              </header>

              {!supported && (
                <div className="p-4 rounded-xl bg-red-50 text-red-700 border border-red-200 mb-6">
                  ä½ çš„ç€è¦½å™¨ç›®å‰ä¸æ”¯æ´èªéŸ³åˆæˆï¼ˆSpeechSynthesisï¼‰ã€‚å»ºè­°ä½¿ç”¨ Chrome / Edgeï¼ˆæ¡Œé¢ç‰ˆï¼‰ã€‚
                </div>
              )}

              {/* Main layout */}
              <div className="grid gap-4 md:grid-cols-3">
                {/* Left: Input + Preview */}
                <div className="md:col-span-2">
                  <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                    <div className="flex items-center justify-between mb-2">
                      <label htmlFor="tts-text" className="font-medium">è¼¸å…¥æ–‡å­—</label>
                      <div className="text-xs text-slate-500">{text.length} å­— Â· é ä¼° {est}</div>
                    </div>
                    <textarea
                      id="tts-text"
                      data-testid="input-text"
                      value={text}
                      onChange={(e) => setText(e.target.value)}
                      placeholder="è²¼ä¸Šæˆ–è¼¸å…¥è¦å”¸å‡ºä¾†çš„æ–‡å­—â€¦"
                      className="w-full h-36 md:h-40 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 p-3 resize-vertical bg-slate-50/50"
                      aria-label="è¼¸å…¥è¦æœ—è®€çš„æ–‡å­—"
                    />

                    {/* Preview with synchronized highlight */}
                    <div className="mt-4">
                      <div className="flex items-center justify-between mb-2">
                        <h2 className="font-medium">é è¦½ï¼ˆåŒæ­¥é«˜äº®ï¼‰</h2>
                        <div className="text-xs text-slate-500">æ®µè½æ•¸ï¼š{chunks.length} Â· é€²åº¦ï¼š{currentIndex >= 0 ? currentIndex + 1 : 0}/{chunks.length}</div>
                      </div>
                      <div className="max-h-64 overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 space-y-2" data-testid="preview-pane">
                        {chunks.length === 0 && (
                          <div className="text-sm text-slate-500">ç„¡æ–‡å­—ï¼Œè«‹åœ¨ä¸Šæ–¹è¼¸å…¥å…§å®¹ã€‚</div>
                        )}
                        {chunks.map((c, i) => {
                          const active = i === currentIndex && (isSpeaking || isPaused);
                          return (
                            <div
                              key={i}
                              ref={chunkRefs.current[i]}
                              data-active={active ? 'true' : 'false'}
                              className={`text-sm leading-relaxed rounded-lg border p-2 cursor-pointer select-none ${
                                active
                                  ? 'bg-yellow-50 border-yellow-300 ring-2 ring-yellow-200'
                                  : 'bg-white border-slate-200 hover:bg-slate-50'
                              }`}
                              onClick={() => speakFromIndex(i)}
                              title={active ? 'æ­£åœ¨æœ—è®€ï¼Œé»æ“Šå¯å¾æ­¤æ®µé‡æ’­' : 'é»æ“Šå¾é€™ä¸€æ®µé–‹å§‹æœ—è®€'}
                            >
                              <span className="opacity-60 mr-2">[{i + 1}]</span>
                              <span>{c}</span>
                            </div>
                          );
                        })}
                      </div>

                      <div className="flex flex-wrap gap-2 mt-3">
                        <button
                          onClick={() => setText(sampleZh)}
                          className="px-3 py-1.5 text-sm rounded-full bg-slate-100 hover:bg-slate-200"
                          type="button"
                        >è¼‰å…¥ä¸­æ–‡ç¤ºä¾‹</button>
                        <button
                          onClick={() => setText(sampleEn)}
                          className="px-3 py-1.5 text-sm rounded-full bg-slate-100 hover:bg-slate-200"
                          type="button"
                        >Load English Sample</button>
                        <button
                          onClick={() => setText("")}
                          className="px-3 py-1.5 text-sm rounded-full bg-slate-100 hover:bg-slate-200"
                          type="button"
                        >æ¸…ç©º</button>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Right: Controls */}
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                  <div className="space-y-4">
                    <div>
                      <label className="block font-medium mb-1">èªéŸ³ï¼ˆVoiceï¼‰</label>
                      <select
                        value={voiceURI}
                        onChange={(e) => setVoiceURI(e.target.value)}
                        className="w-full rounded-xl border border-slate-300 p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                        aria-label="é¸æ“‡èªéŸ³"
                      >
                        {voices.length === 0 && <option>ï¼ˆæ­£åœ¨è¼‰å…¥å¯ç”¨èªéŸ³â€¦ï¼‰</option>}
                        {voices.map((v) => (
                          <option key={v.voiceURI || v.name} value={v.voiceURI || v.name}>
                            {v.name} â€” {v.lang}
                          </option>
                        ))}
                      </select>
                      {selectedVoice && (
                        <div className="mt-1 text-xs text-slate-500">ç›®å‰ï¼š{selectedVoice.name}ï¼ˆ{selectedVoice.lang}ï¼‰</div>
                      )}
                    </div>

                    <div>
                      <label htmlFor="rate" className="block font-medium mb-1">èªé€Ÿï¼ˆ{rate.toFixed(2)}Ã—ï¼‰</label>
                      <input
                        id="rate"
                        data-testid="slider-rate"
                        type="range"
                        min={RATE_MIN}
                        max={RATE_MAX}
                        step={0.05}
                        value={rate}
                        onChange={(e) => setRate(parseFloat(e.target.value))}
                        className="w-full"
                        aria-label="èª¿æ•´èªé€Ÿ"
                      />
                      <div className="flex justify-between text-xs text-slate-500">
                        <span>æ›´æ…¢ï¼ˆ{RATE_MIN}Ã—ï¼‰</span>
                        <span>æ›´å¿«ï¼ˆ{RATE_MAX}Ã—ï¼‰</span>
                      </div>
                      <div className="flex flex-wrap gap-2 mt-2">
                        <button onClick={() => setRate(0.25)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 text-xs" type="button">è¶…æ…¢ 0.25Ã—</button>
                        <button onClick={() => setRate(0.5)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 text-xs" type="button">æ…¢é€ŸÃ—2ï¼ˆ0.5Ã—ï¼‰</button>
                        <button onClick={() => setRate(1.0)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 text-xs" type="button">æ­£å¸¸ 1.0Ã—</button>
                        <button onClick={() => setRate(1.5)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 text-xs" type="button">1.5Ã—</button>
                        <button onClick={() => setRate(2.0)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 text-xs" type="button">2.0Ã—</button>
                      </div>
                    </div>

                    <div className="flex gap-2 pt-2">
                      <button
                        onClick={speak}
                        disabled={!supported || !text.trim()}
                        className="flex-1 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-40 disabled:cursor-not-allowed"
                        data-testid="btn-play"
                        aria-label="é–‹å§‹æœ—è®€"
                      >â–¶ï¸ æœ—è®€</button>
                      {isSpeaking ? (
                        <button onClick={pause} className="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200" aria-label="æš«åœæœ—è®€">â¸ æš«åœ</button>
                      ) : isPaused ? (
                        <button onClick={resume} className="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200" aria-label="ç¹¼çºŒæœ—è®€">â¯ ç¹¼çºŒ</button>
                      ) : (
                        <button disabled className="px-4 py-2 rounded-xl bg-slate-50 text-slate-400 border border-slate-200" aria-disabled>
                          â¸ æš«åœ
                        </button>
                      )}
                      <button onClick={cancelAll} className="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200" aria-label="åœæ­¢æœ—è®€">â¹ åœæ­¢</button>
                    </div>

                    {(isSpeaking || isPaused) && (
                      <div className="text-xs text-slate-500">é€²åº¦ï¼š{currentIndex + 1}/{chunks.length}</div>
                    )}
                  </div>
                </div>
              </div>

              {/* Vocabulary Section */}
              <div className="mt-6 bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="font-medium">å–®å­—èˆ‡è§£é‡‹ï¼ˆVocabularyï¼‰</h2>
                  <div className="flex items-center gap-2 text-sm">
                    <label className="inline-flex items-center gap-1">
                      <input type="checkbox" className="accent-indigo-600" checked={playDefToo} onChange={(e) => setPlayDefToo(e.target.checked)} />
                      <span>ä¸€èµ·å”¸å‡ºè§£é‡‹</span>
                    </label>
                    <label className="inline-flex items-center gap-1">
                      <span>æ¯å€‹é‡è¤‡</span>
                      <select value={repeatAll} onChange={(e) => setRepeatAll(parseInt(e.target.value))} className="border rounded px-1 py-0.5">
                        <option value={1}>1x</option>
                        <option value={2}>2x</option>
                        <option value={3}>3x</option>
                        <option value={5}>5x</option>
                      </select>
                    </label>
                    <button onClick={() => playAllWords(repeatAll, playDefToo)} className="px-3 py-1.5 rounded-full bg-indigo-600 text-white hover:bg-indigo-700">â–¶ï¸ å…¨éƒ¨æ’­æ”¾</button>
                  </div>
                </div>

                {/* Add row */}
                <div className="grid grid-cols-1 md:grid-cols-5 gap-2">
                  <input
                    value={termInput}
                    onChange={(e) => setTermInput(e.target.value)}
                    placeholder="å–®å­—ï¼ˆå¿…å¡«ï¼‰"
                    className="md:col-span-2 rounded-lg border border-slate-300 p-2 bg-slate-50/50 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                    aria-label="å–®å­—"
                  />
                  <input
                    value={defInput}
                    onChange={(e) => setDefInput(e.target.value)}
                    placeholder="è§£é‡‹ï¼ˆé¸å¡«ï¼‰"
                    className="md:col-span-2 rounded-lg border border-slate-300 p-2 bg-slate-50/50 focus:outline-none focus:ring-2 focus:ring-indigo-400"
                    aria-label="è§£é‡‹"
                  />
                  <button
                    type="button"
                    onClick={() => {
                      const ok = addVocab(termInput, defInput);
                      if (ok) { setTermInput(""); setDefInput(""); }
                    }}
                    className="rounded-lg border border-slate-300 px-3 py-2 bg-slate-100 hover:bg-slate-200"
                  >æ–°å¢</button>
                </div>

                {/* List */}
                <div className="mt-3 divide-y divide-slate-200">
                  {vocab.length === 0 ? (
                    <div className="text-sm text-slate-500">å°šæœªæ–°å¢ä»»ä½•å–®å­—ã€‚å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥å–®å­—èˆ‡è§£é‡‹ï¼Œå†æŒ‰ã€Œæ–°å¢ã€ã€‚</div>
                  ) : (
                    vocab.map((item) => (
                      <div key={item.id} className="py-2 flex items-center gap-3">
                        <div className="flex-1 min-w-0">
                          <div className="font-medium truncate">{item.term}</div>
                          {item.definition && <div className="text-sm text-slate-600 truncate">{item.definition}</div>}
                        </div>
                        <div className="flex items-center gap-2 text-sm">
                          <button onClick={() => playWord(item.term, 1, false, item.definition)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">â–¶ï¸ 1x</button>
                          <button onClick={() => playWord(item.term, 3, false, item.definition)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">ğŸ” 3x</button>
                          <button onClick={() => playWord(item.term, 5, false, item.definition)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">ğŸ” 5x</button>
                          <button onClick={() => playWord(item.term, 1, true, item.definition)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200" title="æ’­æ”¾ å–®å­— + è§£é‡‹">è©+è§£é‡‹</button>
                          <button onClick={() => removeVocab(item.id)} className="px-2 py-1 rounded bg-red-50 hover:bg-red-100 text-red-700 border border-red-200">åˆªé™¤</button>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>

              <div className="mt-6 bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                <h2 className="font-medium mb-2">ä½¿ç”¨èªªæ˜</h2>
                <ul className="list-disc list-inside text-sm text-slate-600 space-y-1">
                  <li>è²¼ä¸Šæ–‡å­—ï¼Œé¸æ“‡å–œæ­¡çš„ã€ŒèªéŸ³ã€ï¼Œæ‹–æ›³èª¿æ•´ã€Œèªé€Ÿã€ï¼ŒæŒ‰ã€Œæœ—è®€ã€ã€‚</li>
                  <li>é è¦½å€æœƒé¡¯ç¤ºè‡ªå‹•åˆ†æ®µçš„æ®µè½ï¼Œæœ—è®€æ™‚æœƒåŒæ­¥é«˜äº®ç›®å‰æ®µè½ï¼›é»æ“Šä»»ä¸€æ®µå¯å¾è©²æ®µé–‹å§‹æœ—è®€ã€‚</li>
                  <li>è‹¥æ‰¾ä¸åˆ°ä¸­æ–‡èªéŸ³ï¼Œè«‹åœ¨ç³»çµ±/ç€è¦½å™¨å®‰è£æˆ–å•Ÿç”¨ä¸­æ–‡èªéŸ³åŒ…ï¼ˆä¾‹å¦‚ï¼šMicrosoft Hanhanã€Google åœ‹èªç­‰ï¼‰ã€‚</li>
                  <li>æœ¬å·¥å…·åŸºæ–¼ç€è¦½å™¨å…§å»ºçš„ Web Speech APIï¼Œå¯¦éš›éŸ³è‰²èˆ‡å¯ç”¨èªéŸ³å–æ±ºæ–¼ä½¿ç”¨è€…è£ç½®ã€‚</li>
                </ul>
              </div>

              <details className="mt-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
                <summary className="cursor-pointer select-none font-medium">Dev / Testsï¼ˆé»æˆ‘å±•é–‹ï¼‰</summary>
                <div className="mt-3 space-y-3">
                  <button onClick={runTests} className="px-3 py-1.5 text-sm rounded-full bg-slate-200 hover:bg-slate-300" type="button">
                    Run unit tests
                  </button>
                  {testRuns && (
                    <div className="text-sm">
                      <div className="mb-2">çµæœï¼š{testRuns.filter((t) => t.pass).length}/{testRuns.length} é€šé</div>
                      <ul className="space-y-1">
                        {testRuns.map((t, i) => (
                          <li key={i} className={`px-2 py-1 rounded ${t.pass ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                            <span className="font-medium mr-2">{t.pass ? 'PASS' : 'FAIL'}</span>
                            {t.name} â€” <span className="opacity-70">{t.info}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>
              </details>

              <footer className="py-6 text-center text-xs text-slate-400">Â© {new Date().getFullYear()} ReadBuddyï½œæœ—è®€å¤¥ä¼´</footer>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>