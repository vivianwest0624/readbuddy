<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ReadBuddyï½œæœ—è®€å¤¥ä¼´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>button,[role="button"],summary,select,input[type="range"],.cursor-pointer{cursor:pointer}</style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body class="min-h-screen bg-slate-50">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel" data-presets="env,react" data-plugins="proposal-optional-chaining,proposal-nullish-coalescing-operator">
// ReadBuddyï½œæœ—è®€å¤¥ä¼´ï¼ˆå¯é è¦½ç‰ˆï¼‰
const RATE_MIN=0.25,RATE_MAX=2.0,RATE_ABS_MAX=2.5;
const ARTICLES_KEY='rb_articles_v2',AI_PROVIDER_KEY='rb_ai_provider',AI_KEY_KEY='rb_ai_key',AI_MODEL_KEY='rb_ai_model';
const GOOGLE_SCOPES='https://www.googleapis.com/auth/drive.appdata openid email profile';
const GOOGLE_CLIENT_ID='178234805233-1oge8bider5e4pq50339q9kflit5u6pn.apps.googleusercontent.com';

function App(){
  const storage=React.useMemo(()=>({get(k,f=""){try{if(typeof localStorage==="undefined")return f;const v=localStorage.getItem(k);return v==null?f:v}catch{return f}},set(k,v){try{if(typeof localStorage!=="undefined")localStorage.setItem(k,v)}catch{}}}),[]);

  const[supported]=React.useState(()=>typeof window!=='undefined'&&'speechSynthesis'in window&&typeof SpeechSynthesisUtterance!=='undefined');
  const[text,setText]=React.useState(()=>storage.get('tts_text',''));
  const[rate,setRate]=React.useState(()=>{const x=parseFloat(storage.get('tts_rate','1.0'));return Number.isFinite(x)?x:1});
  const[voices,setVoices]=React.useState([]);const[voiceURI,setVoiceURI]=React.useState(()=>storage.get('tts_voiceURI',''));
  const[status,setStatus]=React.useState('idle');const[currentIndex,setCurrentIndex]=React.useState(-1);
  const[notice,setNotice]=React.useState('');const[defLoading,setDefLoading]=React.useState(false);
  const[vocab,setVocab]=React.useState(()=>{try{return JSON.parse(storage.get('tts_vocab','[]'))||[]}catch{return[]}});
  const[articles,setArticles]=React.useState(()=>{try{const n=storage.get(ARTICLES_KEY,null);if(n){const a=JSON.parse(n);return Array.isArray(a)?a:[]}const o=JSON.parse(storage.get('rb_articles','[]'));return Array.isArray(o)?o:[]}catch{return[]}});
  const[articleId,setArticleId]=React.useState(null);const[articleTitle,setArticleTitle]=React.useState('');
  const[aiProvider,setAiProvider]=React.useState(()=>storage.get(AI_PROVIDER_KEY,'none')||'none');
  const[aiKey,setAiKey]=React.useState(()=>storage.get(AI_KEY_KEY,''));
  const[aiModel,setAiModel]=React.useState(()=>storage.get(AI_MODEL_KEY,'gpt-4o-mini'));

  const gTokRef=React.useRef('');const[gUser,setGUser]=React.useState(null);const[driveFileId,setDriveFileId]=React.useState(null);const[cloudMsg,setCloudMsg]=React.useState('');const tokenClientRef=React.useRef(null);const driveSaveTimerRef=React.useRef(null);

  const queueRef=React.useRef([]),cancelledRef=React.useRef(false),chunkRefs=React.useRef([]);
  const modeRef=React.useRef('idle');const rateChangeTimerRef=React.useRef(null);const charIndexRef=React.useRef(0);const pendingCharRef=React.useRef(0);const pendingIdxRef=React.useRef(null);

  React.useEffect(()=>storage.set('tts_text',text),[text]);
  React.useEffect(()=>storage.set('tts_rate',String(rate)),[rate]);
  React.useEffect(()=>{if(voiceURI)storage.set('tts_voiceURI',voiceURI)},[voiceURI]);
  React.useEffect(()=>{try{storage.set('tts_vocab',JSON.stringify(vocab))}catch{}},[vocab]);
  React.useEffect(()=>{try{storage.set(ARTICLES_KEY,JSON.stringify(articles))}catch{}},[articles]);
  React.useEffect(()=>storage.set(AI_PROVIDER_KEY,aiProvider),[aiProvider]);
  React.useEffect(()=>{if(aiKey)storage.set(AI_KEY_KEY,aiKey)},[aiKey]);
  React.useEffect(()=>storage.set(AI_MODEL_KEY,aiModel||'gpt-4o-mini'),[aiModel]);

  const loadVoices=React.useCallback(()=>{if(!supported)return;const list=window.speechSynthesis.getVoices();setVoices(list);if(!voiceURI&&list.length){const p=list.find(v=>/zh-TW/i.test(v.lang))||list.find(v=>/zh-CN/i.test(v.lang))||list.find(v=>/en-US/i.test(v.lang))||list[0];if(p)setVoiceURI(p.voiceURI||p.name)}},[supported,voiceURI]);
  React.useEffect(()=>{if(!supported)return;loadVoices();window.speechSynthesis.onvoiceschanged=loadVoices;return()=>{if(window.speechSynthesis)window.speechSynthesis.onvoiceschanged=null}},[supported,loadVoices]);

  const countWords=t=>{const latin=(t.match(/\S+/g)||[]).length;const cjk=t.replace(/[\x00-\x7F]/g,'').length/2;return Math.max(latin,Math.round(cjk))};
  const estimateDuration=(txt,r)=>{const w=countWords(txt);if(!w)return"0:00";const sec=Math.ceil((w/(160*Math.max(r,RATE_MIN)))*60);return`${Math.floor(sec/60)}:${String(sec%60).padStart(2,'0')}`};
  function splitIntoChunks(t){const parts=[];const tokens=t.split(/([ã€‚ï¼ï¼Ÿ!?.\n]+)/).reduce((a,c)=>{if(/[ã€‚ï¼ï¼Ÿ!?.\n]+/.test(c)&&a.length)a[a.length-1]+=c;else if(c.trim())a.push(c.trim());return a},[]);const MAX=180;for(const s of tokens){if(s.length<=MAX)parts.push(s);else{let st=0;while(st<s.length){let ed=Math.min(st+MAX,s.length);const slice=s.slice(st,ed);const back=Math.max(slice.lastIndexOf(' '),slice.search(/[ï¼Œã€,;ï¼›]/)>=0?slice.search(/[ï¼Œã€,;ï¼›](?!.*[ï¼Œã€,;ï¼›])/):-1);if(back>40)ed=st+back+1;parts.push(s.slice(st,ed).trim());st=ed}}}return parts}
  const getSelectedVoice=React.useCallback(()=>voices.find(v=>(v.voiceURI||v.name)===voiceURI)||null,[voices,voiceURI]);
  const chunks=React.useMemo(()=>splitIntoChunks((text||'').trim()),[text]);
  React.useEffect(()=>{chunkRefs.current=chunks.map((_,i)=>chunkRefs.current[i]||React.createRef())},[chunks.length]);
  React.useEffect(()=>{if(currentIndex<0)return;const el=chunkRefs.current[currentIndex]?.current;el&&el.scrollIntoView&&el.scrollIntoView({behavior:'smooth',block:'center'})},[currentIndex]);

  const saveArticleWithVocab=(next)=>{const now=new Date().toISOString();const title=(articleTitle||'').trim()||new Date().toLocaleString();if(!articleId){const id=Date.now()+Math.random().toString(36).slice(2);const item={id,title,content:text,vocab:[...next],createdAt:now,updatedAt:now};setArticles(p=>[item,...p]);setArticleId(id);setArticleTitle(title);queueDriveSave()}else{setArticles(p=>p.map(a=>a.id===articleId?{...a,title,content:text,vocab:[...next],updatedAt:now}:a));queueDriveSave()}};
  const updateArticle=()=>saveArticleWithVocab(vocab);
  const newArticle=()=>{setArticleId(null);setArticleTitle('');setText('');setVocab([])};
  const loadArticle=id=>{const a=articles.find(x=>x.id===id);if(!a)return;setArticleId(a.id);setArticleTitle(a.title);setText(a.content||'');setVocab(Array.isArray(a.vocab)?a.vocab:[])};
  const removeArticle=id=>{setArticles(p=>p.filter(x=>x.id!==id));if(id===articleId){setArticleId(null);setArticleTitle('');setText('');setVocab([])}};
  const renameArticle=id=>{const a=articles.find(x=>x.id===id);if(!a)return;const nv=prompt('é‡æ–°å‘½åæ–‡ç« æ¨™é¡Œ',a.title);if(nv==null)return;const title=nv.trim();if(!title)return;const now=new Date().toISOString();setArticles(p=>p.map(x=>x.id===id?{...x,title,updatedAt:now}:x));if(id===articleId)setArticleTitle(title)};

  const sanitize=s=>(s||'').replace(/[\n\r\t]+/g,' ').replace(/^\s+|\s+$/g,'').replace(/^[^A-Za-z0-9ä¸€-é¾¯]+/,'').replace(/[^A-Za-z0-9ä¸€-é¾¯\-â€™' ]+$/,'').slice(0,64);
  const getSelFromTA=()=>{const ta=document.getElementById('tts-text');if(!ta)return'';const s=ta.selectionStart,e=ta.selectionEnd;return(typeof s==='number'&&typeof e==='number'&&e>s)?ta.value.substring(s,e):''};
  const getSelWin=()=>{const sel=window.getSelection&&window.getSelection();return sel?String(sel.toString()):''};
  async function addSelectedUnified(){const raw=getSelFromTA()||getSelWin();const term=sanitize(raw);if(!term){setNotice('è«‹å…ˆé¸å–å–®å­—/ç‰‡èª');return}setNotice('');setDefLoading(true);try{const def=await generateDefinition(term);let next;setVocab(prev=>{const exists=prev.some(x=>x.term.toLowerCase()===term.toLowerCase());next=exists?prev.map(x=>x.term.toLowerCase()===term.toLowerCase()?{...x,definition:def||x.definition}:x):[...prev,{id:Date.now()+Math.random().toString(36).slice(2),term,definition:def||''}];return next});saveArticleWithVocab(next||vocab);setNotice(`å·²åŠ å…¥ä¸¦å„²å­˜ï¼š${term}${def?'ï¼ˆå«è§£é‡‹ï¼‰':'ï¼ˆç„¡è§£é‡‹ï¼‰'}`)}catch(e){console.error(e);let next;setVocab(prev=>{const exists=prev.some(x=>x.term.toLowerCase()===term.toLowerCase());next=exists?prev:[...prev,{id:Date.now()+Math.random().toString(36).slice(2),term,definition:''}];return next});saveArticleWithVocab(next||vocab);setNotice(`å·²åŠ å…¥ä¸¦å„²å­˜ï¼š${term}ï¼ˆAI è§£æå¤±æ•—ï¼Œå…ˆåŠ å…¥å–®å­—ï¼‰`)}finally{setDefLoading(false)}}
  async function generateDefinition(term){
    if(aiProvider==='openai'&&aiKey){try{const resp=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${aiKey}`},body:JSON.stringify({model:aiModel||'gpt-4o-mini',temperature:0.2,messages:[{role:'system',content:'You are a concise bilingual dictionary. Output EXACTLY two lines: "EN: <short English gloss with POS>" and on the next line "ZH: <Traditional Chinese meaning>". Each line max 25 words. One ultra-short example allowed. No extra text.'},{role:'user',content:`Define: ${term}`}]})});if(!resp.ok)throw new Error('OpenAI API error');const data=await resp.json();const txt=data?.choices?.[0]?.message?.content?.trim();if(txt)return txt}catch(e){console.warn('OpenAI error',e)}}
    let en='';try{const r=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(term)}`);if(r.ok){const j=await r.json();const first=Array.isArray(j)&&j[0];const m0=first?.meanings?.[0];const d0=m0?.definitions?.[0]?.definition;const pos=m0?.partOfSpeech?`(${m0.partOfSpeech}) `:'';if(d0)en=`${pos}${d0}`}}catch(e){console.warn('DictAPI error',e)}
    let zh='';if(en){try{const tr=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(en)}&langpair=en|zh-TW`);if(tr.ok){const tj=await tr.json();const tz=tj?.responseData?.translatedText;if(tz)zh=String(tz).trim()}}catch(e){console.warn('Translate error',e)}}
    if(en||zh)return`${en?`EN: ${en}`:''}${en&&zh?'\n':''}${zh?`ZH: ${zh}`:''}`.trim();return'';
  }

  const isGisReady=()=>typeof window!=='undefined'&&window.google&&google.accounts&&google.accounts.oauth2;
  const isClientIdConfigured=()=>GOOGLE_CLIENT_ID&&!/^(YOUR_CLIENT_ID)/.test(GOOGLE_CLIENT_ID);
  function initTokenClient(){if(!isGisReady()||!isClientIdConfigured())return null;if(!tokenClientRef.current){tokenClientRef.current=google.accounts.oauth2.initTokenClient({client_id:GOOGLE_CLIENT_ID,scope:GOOGLE_SCOPES,callback:(resp)=>{if(resp&&resp.access_token){gTokRef.current=resp.access_token;fetchGoogleUser(resp.access_token);ensureDriveFile(resp.access_token);setCloudMsg('å·²ç™»å…¥');setTimeout(()=>setCloudMsg(''),1200)}else setCloudMsg('ç™»å…¥å¤±æ•—')}})}return tokenClientRef.current}
  async function fetchGoogleUser(tok){try{const r=await fetch('https://www.googleapis.com/oauth2/v3/userinfo',{headers:{Authorization:`Bearer ${tok}`}});if(r.ok){const j=await r.json();setGUser({sub:j.sub,name:j.name,email:j.email,picture:j.picture})}}catch{}}
  function signInGoogle(){if(!isClientIdConfigured()){setCloudMsg('å°šæœªè¨­å®š Google Client ID');return}const c=initTokenClient();if(!c){setCloudMsg('Google ç™»å…¥å°šæœªå°±ç·’');return}try{c.requestAccessToken({prompt:'consent'})}catch{setCloudMsg('ç™»å…¥éŒ¯èª¤')}}
  function signOutGoogle(){const tok=gTokRef.current;gTokRef.current='';setGUser(null);setDriveFileId(null);try{if(tok&&isGisReady())google.accounts.oauth2.revoke(tok,()=>{})}catch{}setCloudMsg('å·²ç™»å‡º');setTimeout(()=>setCloudMsg(''),1200)}
  async function ensureDriveFile(tok){try{const q=encodeURIComponent("name = 'readbuddy_articles.json' and 'appDataFolder' in parents and trashed = false");const r=await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&spaces=appDataFolder&fields=files(id,name)`,{headers:{Authorization:`Bearer ${tok}`}});if(r.ok){const j=await r.json();if(j.files&&j.files.length){setDriveFileId(j.files[0].id);return j.files[0].id}}const boundary='b'+Math.random().toString(16).slice(2);const meta={name:'readbuddy_articles.json',parents:['appDataFolder'],mimeType:'application/json'};const initData=JSON.stringify({version:1,articles});const body=`--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(meta)}\r\n--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${initData}\r\n--${boundary}--`;const cr=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{method:'POST',headers:{Authorization:`Bearer ${tok}`,'Content-Type':`multipart/related; boundary=${boundary}`},body});if(cr.ok){const cj=await cr.json();setDriveFileId(cj.id);return cj.id}}catch{setCloudMsg('å»ºç«‹é›²ç«¯æª”æ¡ˆå¤±æ•—')}return null}
  async function loadFromDrive(){const tok=gTokRef.current;if(!tok){setCloudMsg('è«‹å…ˆç™»å…¥');return}const id=driveFileId||await ensureDriveFile(tok);if(!id)return;try{const r=await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`,{headers:{Authorization:`Bearer ${tok}`}});if(r.ok){const j=await r.json();if(j&&Array.isArray(j.articles)){setArticles(j.articles);setCloudMsg('å·²å¾é›²ç«¯è¼‰å…¥');setTimeout(()=>setCloudMsg(''),1200)}}}catch{setCloudMsg('é›²ç«¯è¼‰å…¥å¤±æ•—')}}
  async function saveToDriveNow(){const tok=gTokRef.current;if(!tok)return;const id=driveFileId||await ensureDriveFile(tok);if(!id)return;const data=JSON.stringify({version:1,articles});try{const r=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`,{method:'PATCH',headers:{Authorization:`Bearer ${tok}`,'Content-Type':'application/json'},body:data});if(r.ok){setCloudMsg('é›²ç«¯å·²å„²å­˜');setTimeout(()=>setCloudMsg(''),1000)}}catch{setCloudMsg('é›²ç«¯å„²å­˜å¤±æ•—')}}
  function queueDriveSave(){if(!gTokRef.current)return;if(driveSaveTimerRef.current)clearTimeout(driveSaveTimerRef.current);driveSaveTimerRef.current=setTimeout(saveToDriveNow,500)}

  function handleRateChange(v){const clamped=Math.min(Math.max(v,RATE_MIN),RATE_MAX);setRate(clamped);if(!supported)return;if(status==='speaking'&&modeRef.current==='article'){if(rateChangeTimerRef.current)clearTimeout(rateChangeTimerRef.current);rateChangeTimerRef.current=setTimeout(()=>{try{window.speechSynthesis.cancel()}catch{}cancelledRef.current=false;const startAt=currentIndex>=0?currentIndex:0;const charAt=charIndexRef.current||0;setTimeout(()=>speakFromIndex(startAt,charAt),0)},120)}else if(status==='paused'&&modeRef.current==='article'){try{window.speechSynthesis.cancel()}catch{}pendingIdxRef.current=currentIndex>=0?currentIndex:0;pendingCharRef.current=charIndexRef.current||0;setStatus('paused')}}

  function cancelAll(){if(!supported)return;cancelledRef.current=true;try{window.speechSynthesis.cancel()}catch{}queueRef.current=[];modeRef.current='idle';pendingIdxRef.current=null;setStatus('idle');setCurrentIndex(-1)}
  function speakFromIndex(startIndex=0,charOffset=0){if(!supported||!(text||'').trim())return;cancelAll();cancelledRef.current=false;modeRef.current='article';queueRef.current=chunks;const voice=getSelectedVoice();const clamp=x=>Math.min(Math.max(x,RATE_MIN),RATE_ABS_MAX);const speakChunk=(i,off)=>{if(cancelledRef.current)return;if(i>=queueRef.current.length){setStatus('idle');setCurrentIndex(-1);return}let chunkText=String(queueRef.current[i]||'');if(off&&off>0){if(off>=chunkText.length){speakChunk(i+1,0);return}chunkText=chunkText.slice(off)}const u=new SpeechSynthesisUtterance(chunkText);if(voice)u.voice=voice;u.rate=clamp(rate);u.pitch=1.0;u.onstart=()=>{setStatus('speaking');setCurrentIndex(i);charIndexRef.current=off||0};u.onboundary=e=>{if(typeof e.charIndex==='number'){charIndexRef.current=(off||0)+e.charIndex}};u.onend=()=>{charIndexRef.current=0;setTimeout(()=>speakChunk(i+1,0),20)};u.onerror=()=>{charIndexRef.current=0;setTimeout(()=>speakChunk(i+1,0),20)};window.speechSynthesis.speak(u)};speakChunk(startIndex,charOffset||0)}
  const speak=()=>speakFromIndex(0);const pause=()=>{if(!supported)return;window.speechSynthesis.pause();setStatus('paused')};
  function resume(){if(!supported)return;if(window.speechSynthesis.speaking){try{window.speechSynthesis.resume()}catch{}setStatus('speaking')}else{const idx=pendingIdxRef.current!=null?pendingIdxRef.current:(currentIndex>=0?currentIndex:0);const off=pendingCharRef.current||0;pendingIdxRef.current=null;pendingCharRef.current=0;speakFromIndex(idx,off)}}

  function speakSeq(arr){if(!supported||!arr.length)return;cancelAll();cancelledRef.current=false;modeRef.current='vocab';const v=getSelectedVoice();let i=-1;const next=()=>{if(cancelledRef.current)return;i++;if(i>=arr.length){setStatus('idle');return}const u=new SpeechSynthesisUtterance(arr[i]);if(v)u.voice=v;u.rate=Math.min(Math.max(rate,RATE_MIN),RATE_ABS_MAX);u.pitch=1.0;u.onstart=()=>{setStatus('speaking');setCurrentIndex(-1)};u.onend=()=>setTimeout(next,120);u.onerror=()=>setTimeout(next,120);window.speechSynthesis.speak(u)};next()}
  const playWord=(t,times=3,withDef=false,def="")=>{const arr=[];for(let i=0;i<times;i++){arr.push(t);if(withDef&&def)arr.push(def)}speakSeq(arr)};
  const playAllWords=(times=2,withDef=false)=>{const arr=[];vocab.forEach(it=>{for(let i=0;i<times;i++){arr.push(it.term);if(withDef&&it.definition)arr.push(it.definition)}});speakSeq(arr)};

  function addVocab(term,definition){const t=(term||'').trim(),d=(definition||'').trim();if(!t)return false;setVocab(prev=>{const ex=prev.some(x=>x.term.toLowerCase()===t.toLowerCase());if(ex)return prev.map(x=>x.term.toLowerCase()===t.toLowerCase()?{...x,definition:d||x.definition}:x);return[...prev,{id:Date.now()+Math.random().toString(36).slice(2),term:t,definition:d}]});return true}
  const removeVocab=id=>setVocab(prev=>prev.filter(x=>x.id!==id));

  const isSpeaking=status==='speaking',isPaused=status==='paused';
  const est=estimateDuration(text,rate);const selectedVoice=getSelectedVoice();

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 text-slate-800">
      <div className="max-w-6xl mx-auto p-6">
        <header className="flex items-center justify-between mb-6">
          <h1 className="text-2xl md:text-3xl font-semibold tracking-tight">ReadBuddyï½œæœ—è®€å¤¥ä¼´</h1>
          <GoogleBar {...{signInGoogle,signOutGoogle,saveToDriveNow,loadFromDrive,isClientIdConfigured}} gUser={gUser} cloudMsg={cloudMsg} />
        </header>

        {!supported&&(<div className="p-4 rounded-xl bg-red-50 text-red-700 border border-red-200 mb-6">ä½ çš„ç€è¦½å™¨ç›®å‰ä¸æ”¯æ´èªéŸ³åˆæˆï¼ˆSpeechSynthesisï¼‰ã€‚å»ºè­°ä½¿ç”¨ Chrome / Edgeï¼ˆæ¡Œé¢ç‰ˆï¼‰ã€‚</div>)}

        <div className="grid gap-4 md:grid-cols-3">
          <div className="md:col-span-2">
            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
              <div className="mb-3 grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                <div className="md:col-span-2">
                  <label className="block text-sm font-medium mb-1" htmlFor="article-title">æ–‡ç« æ¨™é¡Œ</label>
                  <input id="article-title" value={articleTitle} onChange={e=>setArticleTitle(e.target.value)} placeholder="æœªå‘½åæ–‡ç« " className="w-full rounded-xl border border-slate-300 p-2 bg-slate-50/50 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
                </div>
                <div className="flex gap-2 md:justify-end flex-wrap">
                  <button onClick={updateArticle} className="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">ğŸ’¾ å„²å­˜</button>
                  <button onClick={newArticle} className="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">ğŸ“ æ–°æ–‡ç« </button>
                </div>
              </div>

              <div className="mb-3">
                <div className="flex items-center justify-between mb-1"><h3 className="text-sm font-medium">æˆ‘çš„æ–‡ç« </h3><span className="text-xs text-slate-500">{articles.length} ç¯‡</span></div>
                <div className="max-h-36 overflow-auto divide-y divide-slate-200 rounded-xl border border-slate-200 bg-slate-50">
                  {articles.length===0?(<div className="p-3 text-sm text-slate-500">å°šæœªå„²å­˜ä»»ä½•æ–‡ç« ã€‚è¼¸å…¥æ¨™é¡Œèˆ‡å…§å®¹å¾ŒæŒ‰ã€Œå„²å­˜ã€ã€‚</div>):(
                    articles.map(a=>(
                      <div key={a.id} className={`p-2 flex items-center gap-2 ${a.id===articleId?'bg-indigo-50':'bg-white'}`}>
                        <button className="flex-1 text-left truncate cursor-pointer" onClick={()=>loadArticle(a.id)} title={new Date(a.updatedAt).toLocaleString()}>
                          <div className="font-medium truncate">{a.title}</div>
                          <div className="text-xs text-slate-500">æ›´æ–°ï¼š{new Date(a.updatedAt).toLocaleString()} Â· å–®å­— {Array.isArray(a.vocab)?a.vocab.length:0}</div>
                        </button>
                        <button className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 text-xs" onClick={()=>renameArticle(a.id)}>é‡æ–°å‘½å</button>
                        <button className="px-2 py-1 rounded bg-red-50 hover:bg-red-100 text-xs text-red-700 border border-red-200" onClick={()=>removeArticle(a.id)}>åˆªé™¤</button>
                      </div>
                    ))
                  )}
                </div>
              </div>

              <div className="flex items-center justify-between mb-2">
                <label htmlFor="tts-text" className="font-medium">è¼¸å…¥æ–‡å­—</label>
                <div className="text-xs text-slate-500">{text.length} å­— Â· é ä¼° {est}</div>
              </div>
              <textarea id="tts-text" value={text} onChange={e=>setText(e.target.value)} onDoubleClick={()=>addSelectedUnified()} onKeyDown={e=>{if(e.key==='Enter'){const ta=e.target;const s=ta.selectionStart,en=ta.selectionEnd;if(typeof s==='number'&&typeof en==='number'&&en>s){e.preventDefault();addSelectedUnified()}}}} placeholder="è²¼ä¸Šæˆ–è¼¸å…¥è¦å”¸å‡ºä¾†çš„æ–‡å­—â€¦ï¼ˆåç™½ã€é›™æ“Šæˆ–æŒ‰ Enter å¯åŠ å…¥ Vocabularyï¼‰" className="w-full h-40 md:h-44 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 p-3 resize-vertical bg-slate-50/50" aria-label="è¼¸å…¥è¦æœ—è®€çš„æ–‡å­—" />

              <div className="mt-4">
                <div className="flex items-center justify-between mb-2"><h2 className="font-medium">é è¦½ï¼ˆåŒæ­¥é«˜äº®ï¼‰</h2><div className="text-xs text-slate-500">æ®µè½æ•¸ï¼š{chunks.length} Â· é€²åº¦ï¼š{currentIndex>=0?currentIndex+1:0}/{chunks.length}</div></div>
                <div className="max-h-64 overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 space-y-2" data-testid="preview-pane" tabIndex={0} onKeyDown={e=>{if(e.key==='Enter'){const s=(window.getSelection&&window.getSelection().toString().trim());if(s){e.preventDefault();addSelectedUnified()}}}}>
                  {chunks.length===0&&(<div className="text-sm text-slate-500">ç„¡æ–‡å­—ï¼Œè«‹åœ¨ä¸Šæ–¹è¼¸å…¥å…§å®¹ã€‚</div>)}
                  {chunks.map((c,i)=>{const active=i===currentIndex&&(isSpeaking||isPaused);return(
                    <div key={i} ref={chunkRefs.current[i]} data-active={active?'true':'false'} className={`text-sm leading-relaxed rounded-lg border p-2 cursor-pointer select-text ${active?'bg-yellow-50 border-yellow-300 ring-2 ring-yellow-200':'bg-white border-slate-200 hover:bg-slate-50'}`} onClick={e=>{if(e.detail>1)return;const hasSel=(window.getSelection&&window.getSelection().toString().trim().length>0);if(hasSel)return;speakFromIndex(i)}} onDoubleClick={e=>{e.preventDefault();e.stopPropagation();addSelectedUnified()}} title={active?'æ­£åœ¨æœ—è®€ï¼›å¯åç™½æˆ–é›™æ“Šé¸å­—ï¼ˆæ–°å¢å–®å­—ï¼‰ï¼Œæˆ–é»æ“Šå¾æ­¤æ®µé‡æ’­':'å¯åç™½æˆ–é›™æ“Šé¸å­—ï¼ˆæ–°å¢å–®å­—ï¼‰ï¼›é»æ“Šå¾é€™ä¸€æ®µé–‹å§‹æœ—è®€'}>
                      <span className="opacity-60 mr-2">[{i+1}]</span>
                      <span>{c}</span>
                    </div>)})}
                </div>
                {notice&&<div className="mt-2 text-xs text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg px-2 py-1">{notice}</div>}
              </div>
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
            <div className="space-y-4">
              <div>
                <label className="block font-medium mb-1">èªéŸ³ï¼ˆVoiceï¼‰</label>
                <select value={voiceURI} onChange={e=>setVoiceURI(e.target.value)} className="w-full rounded-xl border border-slate-300 p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400" aria-label="é¸æ“‡èªéŸ³">
                  {voices.length===0&&<option>ï¼ˆæ­£åœ¨è¼‰å…¥å¯ç”¨èªéŸ³â€¦ï¼‰</option>}
                  {voices.map(v=>(<option key={v.voiceURI||v.name} value={v.voiceURI||v.name}>{v.name} â€” {v.lang}</option>))}
                </select>
                {selectedVoice&&(<div className="mt-1 text-xs text-slate-500">ç›®å‰ï¼š{selectedVoice.name}ï¼ˆ{selectedVoice.lang}ï¼‰</div>)}
              </div>

              <div>
                <label htmlFor="rate" className="block font-medium mb-1">èªé€Ÿï¼ˆ{rate.toFixed(2)}Ã—ï¼‰</label>
                <input id="rate" type="range" min={RATE_MIN} max={RATE_MAX} step={0.05} value={rate} onChange={e=>handleRateChange(parseFloat(e.target.value))} className="w-full" aria-label="èª¿æ•´èªé€Ÿ" />
                <div className="flex justify-between text-xs text-slate-500"><span>æ›´æ…¢ï¼ˆ{RATE_MIN}Ã—ï¼‰</span><span>æ›´å¿«ï¼ˆ{RATE_MAX}Ã—ï¼‰</span></div>
                <div className="flex flex-wrap gap-2 mt-2">
                  <button onClick={()=>handleRateChange(0.25)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 text-xs" type="button">è¶…æ…¢ 0.25Ã—</button>
                  <button onClick={()=>handleRateChange(0.5)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 text-xs" type="button">æ…¢é€ŸÃ—2ï¼ˆ0.5Ã—ï¼‰</button>
                  <button onClick={()=>handleRateChange(1.0)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 text-xs" type="button">æ­£å¸¸ 1.0Ã—</button>
                  <button onClick={()=>handleRateChange(1.5)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 text-xs" type="button">1.5Ã—</button>
                  <button onClick={()=>handleRateChange(2.0)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200 text-xs" type="button">2.0Ã—</button>
                </div>
              </div>

              <div className="flex gap-2 pt-2">
                <button onClick={speak} disabled={!supported||(text||'').trim().length===0} className="flex-1 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-40 disabled:cursor-not-allowed" aria-label="é–‹å§‹æœ—è®€">â–¶ï¸ æœ—è®€</button>
                {isSpeaking?(<button onClick={pause} className="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200" aria-label="æš«åœæœ—è®€">â¸ æš«åœ</button>):isPaused?(<button onClick={resume} className="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200" aria-label="ç¹¼çºŒæœ—è®€">â¯ ç¹¼çºŒ</button>):(<button disabled className="px-4 py-2 rounded-xl bg-slate-50 text-slate-400 border border-slate-200" aria-disabled>â¸ æš«åœ</button>)}
                <button onClick={cancelAll} className="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200" aria-label="åœæ­¢æœ—è®€">â¹ åœæ­¢</button>
              </div>
              {(isSpeaking||isPaused)&&(<div className="text-xs text-slate-500">é€²åº¦ï¼š{currentIndex+1}/{chunks.length}</div>)}

              <div className="pt-2 border-t border-slate-200">
                <details className="rounded-xl bg-slate-50 p-3">
                  <summary className="cursor-pointer select-none font-medium">AI è¨­å®šï¼ˆå¯é¸ï¼‰</summary>
                  <div className="mt-3 space-y-2 text-sm">
                    <label className="block">æä¾›è€…
                      <select value={aiProvider} onChange={e=>setAiProvider(e.target.value)} className="mt-1 w-full rounded border p-1">
                        <option value="none">ä¸ä½¿ç”¨ï¼ˆåƒ…å­—å…¸å‚™æ´ï¼‰</option>
                        <option value="openai">OpenAIï¼ˆéœ€ API Keyï¼‰</option>
                      </select>
                    </label>
                    {aiProvider==='openai'&&(<>
                      <label className="block">API Key
                        <input type="password" value={aiKey} onChange={e=>setAiKey(e.target.value)} placeholder="sk-..." className="mt-1 w-full rounded border p-1" />
                      </label>
                      <label className="block">Model
                        <input type="text" value={aiModel} onChange={e=>setAiModel(e.target.value)} className="mt-1 w-full rounded border p-1" />
                      </label>
                      <div className="text-[11px] text-slate-500">æé†’ï¼šå‰ç«¯å­˜æ”¾ Key åƒ…ä¾›å€‹äººæ¸¬è©¦ï¼Œæ­£å¼ä¸Šç·šè«‹æ”¹ç”¨å¾Œç«¯ä»£ç†ã€‚</div>
                    </>)}
                  </div>
                </details>
              </div>
            </div>
          </div>
        </div>

        <div className="mt-6 bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
          <div className="flex items-center justify-between mb-3">
            <h2 className="font-medium">å–®å­—èˆ‡è§£é‡‹ï¼ˆVocabularyï¼‰</h2>
            <div className="flex items-center gap-2 text-sm">
              <button onClick={()=>addSelectedUnified()} disabled={defLoading} className="px-3 py-1.5 rounded-full bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50">{defLoading?'â³ è§£æä¸­â€¦':'ğŸ¤– å¾é¸å–æ–°å¢ï¼ˆå«AIè§£é‡‹ï¼‰'}</button>
              <button onClick={()=>playAllWords(2,false)} className="px-3 py-1.5 rounded-full bg-indigo-600 text-white hover:bg-indigo-700">â–¶ï¸ å…¨éƒ¨æ’­æ”¾ï¼ˆæ¯è© 2xï¼‰</button>
            </div>
          </div>
          <VocabEditor addVocab={addVocab} />
          <VocabList vocab={vocab} playWord={playWord} removeVocab={removeVocab} />
        </div>

        <div className="mt-6 bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
          <h2 className="font-medium mb-2">ä½¿ç”¨èªªæ˜</h2>
          <ul className="list-disc list-inside text-sm text-slate-600 space-y-1">
            <li>åœ¨ç·¨è¼¯æ¡†æˆ–é è¦½å€<strong>é›™æ“Š</strong>å–®å­—ï¼ˆæˆ–åç™½é¸å–ã€<strong>æŒ‰ Enter</strong>ï¼‰å³å¯åŠ å…¥ Vocabularyï¼Œä¸¦è‡ªå‹•ç”¢ç”Ÿ<strong>è‹±æ–‡ï¼‹ç¹ä¸­</strong>é›™èªè§£é‡‹ï¼ˆå¤±æ•—å‰‡åƒ…åŠ å…¥å–®å­—ï¼‰ã€‚</li>
            <li>åŠ å…¥å¾Œæœƒè‡ªå‹•æŠŠ<strong>æ–‡ç« ï¼‹å–®å­—è¡¨</strong>ä¸€èµ·å„²å­˜ï¼›è¼‰å…¥æ–‡ç« æ™‚æœƒå¸¶å‡ºå…¶å°ˆå±¬å–®å­—è¡¨ã€‚</li>
            <li>æœ—è®€æ”¯æ´åŒæ­¥é«˜äº®èˆ‡æ®µè½é»é¸æ’­æ”¾ï¼›èªé€Ÿåœ¨æœ—è®€ä¸­å¯å¹³æ»‘èª¿æ•´ä¸ä¸­æ–·ã€‚</li>
            <li>ç™»å…¥å¾Œå¯æŠŠæ–‡ç« æ¸…å–®åŒæ­¥åˆ°å€‹äºº Google Drive çš„ appDataFolderï¼ˆæœ¬æ©Ÿè³‡æ–™ä»æœƒä¿ç•™ï¼‰ã€‚</li>
          </ul>
        </div>

        <footer className="py-6 text-center text-xs text-slate-400">Â© {new Date().getFullYear()} ReadBuddyï½œæœ—è®€å¤¥ä¼´</footer>
      </div>
    </div>
  )
}

function GoogleBar({signInGoogle,signOutGoogle,saveToDriveNow,loadFromDrive,isClientIdConfigured,gUser,cloudMsg}){
  return (
    <div className="flex items-center gap-2 text-sm">
      {gUser?(
        <>
          {gUser.picture&&(<img src={gUser.picture} alt="avatar" className="w-6 h-6 rounded-full" />)}
          <span className="text-slate-600 max-w-[12rem] truncate" title={gUser.email||gUser.name||''}>{gUser.email||gUser.name||'å·²ç™»å…¥'}</span>
          <button onClick={saveToDriveNow} className="px-2 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700">ä¸Šå‚³</button>
          <button onClick={loadFromDrive} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">ä¸‹è¼‰</button>
          <button onClick={signOutGoogle} className="px-2 py-1 rounded bg-red-50 text-red-700 border border-red-200 hover:bg-red-100">ç™»å‡º</button>
          {cloudMsg&&(<span className="text-xs text-slate-700 bg-slate-100 border border-slate-200 rounded px-2 py-0.5">{cloudMsg}</span>)}
        </>
      ):(
        <div className="flex items-center gap-2">
          {!isClientIdConfigured()&&<span className="text-xs text-red-600">è«‹åœ¨å¸¸æ•¸ GOOGLE_CLIENT_ID ä¸­å¡«å…¥ä½ çš„ Client ID</span>}
          <button onClick={signInGoogle} className="px-2 py-1 rounded bg-indigo-600 text-white hover:bg-indigo-700" disabled={!isClientIdConfigured()}>ç™»å…¥ Google</button>
        </div>
      )}
    </div>
  )
}

function VocabEditor({addVocab}){const[term,setTerm]=React.useState('');const[definition,setDefinition]=React.useState('');return(<div className="grid grid-cols-1 md:grid-cols-5 gap-2"><input value={term} onChange={e=>setTerm(e.target.value)} placeholder="å–®å­—ï¼ˆå¿…å¡«ï¼‰" className="md:col-span-2 rounded-lg border border-slate-300 p-2 bg-slate-50/50 focus:outline-none focus:ring-2 focus:ring-indigo-400" aria-label="å–®å­—" /><input value={definition} onChange={e=>setDefinition(e.target.value)} placeholder="è§£é‡‹ï¼ˆé¸å¡«ï¼‰" className="md:col-span-2 rounded-lg border border-slate-300 p-2 bg-slate-50/50 focus:outline-none focus:ring-2 focus:ring-indigo-400" aria-label="è§£é‡‹" /><button type="button" onClick={()=>{const ok=addVocab(term,definition);if(ok){setTerm('');setDefinition('')}}} className="rounded-lg border border-slate-300 px-3 py-2 bg-slate-100 hover:bg-slate-200">æ–°å¢</button></div>)}
function VocabList({vocab,playWord,removeVocab}){return(<div className="mt-3 divide-y divide-slate-200">{vocab.length===0?(<div className="text-sm text-slate-500">å°šæœªæ–°å¢ä»»ä½•å–®å­—ã€‚å¯åœ¨æ–‡ç« æˆ–é è¦½ä¸­åç™½ã€é›™æ“Šæˆ–æŒ‰ Enter æ–°å¢ã€‚</div>):(vocab.map(it=>(<div key={it.id} className="py-2 flex items-center gap-3"><div className="flex-1 min-w-0"><div className="font-medium truncate">{it.term}</div>{it.definition&&<div className="text-sm text-slate-600 truncate">{it.definition}</div>}</div><div className="shrink-0 flex gap-2"><button onClick={()=>playWord(it.term,2,true,it.definition)} className="px-2 py-1 rounded bg-slate-100 hover:bg-slate-200">ğŸ—£ï¸ è©+è§£é‡‹</button><button onClick={()=>removeVocab(it.id)} className="px-2 py-1 rounded bg-red-50 hover:bg-red-100 text-red-700 border border-red-200">åˆªé™¤</button></div></div>)))}</div>)}

const root=ReactDOM.createRoot(document.getElementById('root'));root.render(<App/>);
    </script>
  </body>
</html>
