<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ReadBuddy｜朗讀夥伴（修復＋自動測試）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    button,[role=button],summary,select,input[type=range],.cursor-pointer{cursor:pointer}
    html,body{height:100%}
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <div id="root"></div>

  <!-- React 18 + Babel UMD -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="env,react" data-plugins="proposal-optional-chaining,proposal-nullish-coalescing-operator">
  // ======================================
  // ReadBuddy 精簡版（修復 Script error＋強化自動測試）
  // - 修正：移除多餘殘段造成的語法錯誤（Script error）
  // - 保留並擴充自動測試（不改既有用例）
  // - 功能：朗讀中可即時變速；vocab 模式即時套用；單字點擊播放一次；置中高亮等
  // ======================================

  // --- 常數與小工具 ---
  const K={RATE_MIN:.25,RATE_MAX:1,ABS_MAX:1,ART:'rb_articles_v2'};
  const S={g:(k,f="")=>{try{return localStorage.getItem(k)??f}catch{return f}},s:(k,v)=>{try{localStorage.setItem(k,v)}catch{}}};
  const clamp=(x,a,b)=>Math.min(Math.max(x,a),b);
  const triple=(arr,times=3)=>{const out=[];for(const t of arr){for(let i=0;i<times;i++) out.push(t);}return out};
  const split=(t)=>{
    if(!t||!t.trim())return[];
    const tok=t.split(/([。！？!?\.\n]+)/).reduce((a,c)=>{if(/[。！？!?\.\n]+/.test(c)&&a.length)a[a.length-1]+=c;else if(c.trim())a.push(c.trim());return a;},[]);
    const out=[];const MAX=160;
    for(const s of tok){
      if(s.length<=MAX) out.push(s);
      else{ let i=0; while(i<s.length){
        let e=Math.min(i+MAX,s.length),sl=s.slice(i,e),b=Math.max(sl.lastIndexOf(' '),sl.lastIndexOf('，'),sl.lastIndexOf(','),sl.lastIndexOf('；'),sl.lastIndexOf(';'));
        if(b>40) e=i+b+1; out.push(s.slice(i,e).trim()); i=e;
      }}
    }
    return out;
  };
  const selText=()=>{const ta=document.getElementById('tts-text');if(ta&&ta.selectionEnd>ta.selectionStart)return ta.value.slice(ta.selectionStart,ta.selectionEnd);const w=window.getSelection&&window.getSelection();return w?String(w.toString()):''};
  const sanitize=(s)=>String(s||'').replace(/[\n\r\t]+/g,' ').trim().replace(/^[^A-Za-z0-9\u4e00-\u9fff]+|[^A-Za-z0-9\u4e00-\u9fff\-’' ]+$/g,'').slice(0,64);
  const parseZH=(def)=>{const m=String(def||'').match(/\bZH:\s*([^\n]+)/i);if(!m)return'';return m[1].replace(/[，,；;、]/g,'/').replace(/\s*\/?\s*或\s*/g,'/').replace(/\s{2,}/g,' ').trim()};

  // --- 自動測試（純函式；不中斷 UI） ---
  function runSelfTests(){
    let passed=0, failed=0; const logs=[];
    const assert=(cond,msg)=>{if(!cond){failed++;logs.push('❌ '+msg)}else{passed++;logs.push('✅ '+msg)}};
    try{
      // split 測試（保留＋邊界）
      const a0=split(''); assert(Array.isArray(a0)&&a0.length===0,'split 空字串→空陣列');
      const a1=split('Hello world. This is a test! 好嗎？\nNext line。');
      assert(Array.isArray(a1)&&a1.length>=3,'split 基本分句');
      const long='x'.repeat(170)+' '+"y".repeat(170); const a2=split(long);
      assert(a2.length>=2,'split 會切割超長段落');
      const a3=split('中文？！English?!'); assert(a3.length>=1,'split 可處理中英標點組合');
      // 新增：僅換行不應產出空段
      const a4=split('\r\n\n   '); assert(a4.length===0,'split 僅空白/換行→空');

      // sanitize 測試（保留＋新增空字）
      assert(sanitize('  “Hello,”  ').toLowerCase()==='hello','sanitize 去除邊界符號');
      assert(sanitize("I'm #1!")==="I'm 1",'sanitize 保留撇號與數字，移除雜訊');
      assert(sanitize('abc-xyz').includes('-'),'sanitize 保留連字號');
      assert(sanitize('')==='', 'sanitize 空字串');

      // parseZH 測試（保留）
      const zh1=parseZH('EN: sth\nZH: 甲，乙、丙 或 丁');
      assert(zh1==='甲/乙/丙/丁','parseZH 斜線分隔同義詞');
      const zh2=parseZH('EN: only'); assert(zh2==='','parseZH 無 ZH 行→空字串');

      // clamp 測試（保留）
      assert(clamp(3,0.25,2.5)===2.5,'clamp 上限');
      assert(clamp(0.1,0.25,2.5)===0.25,'clamp 下限');
      assert(clamp(1,0.25,2.5)===1,'clamp 中間值');

      // 新增：三倍展開助手
      const t1=triple(['a','b'],3); assert(JSON.stringify(t1)===JSON.stringify(['a','a','a','b','b','b']),'triple 3x');
      const t2=triple(['a'],1); assert(JSON.stringify(t2)===JSON.stringify(['a']),'triple 1x');

      // 新增：速率上下限常數
      assert(K.RATE_MIN===0.25 && K.RATE_MAX===1,'K 常數：速率上下限應為 0.25~1.00');

      // 綜合：英文大量空白切詞（保留）
      const words='word '.repeat(200); const ch=split(words); assert(ch.every(Boolean),'split 對英文空白切詞');
    }catch(e){failed++;logs.push('❌ 測試程式錯誤：'+(e?.message||e));}

    // 顯示結果（角落徽章；不干擾操作）
    try{
      const div=document.createElement('div');
      div.textContent=failed?`Self-tests: ${passed} pass / ${failed} fail`:`Self-tests: ${passed} pass`;
      div.style.cssText=`position:fixed;right:.5rem;bottom:.5rem;padding:.25rem .5rem;border-radius:.5rem;font:12px system-ui;background:${failed?'#fee2e2':'#ecfdf5'};color:${failed?'#991b1b':'#065f46'};border:1px solid ${failed?'#fecaca':'#a7f3d0'};z-index:2147483647;pointer-events:none;opacity:.9`;
      document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(div));
    }catch{}

    console.log('\n—— ReadBuddy 自動測試 ——'); logs.forEach(l=>console.log(l)); console.log(`總結：${passed} 通過 / ${failed} 失敗`);
    return {passed,failed};
  }

  try{window.__RB_TEST_RESULT=runSelfTests()}catch{}

  function App(){
    // --- 狀態 ---
    const [text,setText]=React.useState(()=>S.g('tts_text',''));
    const [rate,setRate]=React.useState(()=>{const x=parseFloat(S.g('tts_rate','1'));return Number.isFinite(x)?x:1});
    const [voices,setVoices]=React.useState([]);
    const [voiceId,setVoiceId]=React.useState(()=>S.g('tts_voiceURI',''));
    const [status,setStatus]=React.useState('idle'); // idle|speaking|paused
    const [idx,setIdx]=React.useState(-1);
    const charRef=React.useRef(0); const modeRef=React.useRef('idle'); const cancelRef=React.useRef(false);
    const chunks=React.useMemo(()=>split(text),[text]);
    const [vocab,setVocab]=React.useState(()=>{try{return JSON.parse(S.g('tts_vocab','[]'))}catch{return[]}});
    const [articles,setArticles]=React.useState(()=>{try{const raw=S.g(K.ART,null);return raw?JSON.parse(raw):[]}catch{return[]}});
    const [aid,setAid]=React.useState(null); const [title,setTitle]=React.useState('');
    const [aiOn,setAiOn]=React.useState(()=>S.g('ai_on','0')==='1');
    const [aiKey,setAiKey]=React.useState(()=>S.g('ai_key',''));
    const [aiModel,setAiModel]=React.useState(()=>S.g('ai_model','gpt-4o-mini'));
    const [busy,setBusy]=React.useState(false); const [note,setNote]=React.useState('');
    const supported=typeof window!=='undefined'&&'speechSynthesis'in window&&typeof SpeechSynthesisUtterance!=='undefined';

    // --- 永續化 ---
    React.useEffect(()=>S.s('tts_text',text),[text]);
    React.useEffect(()=>S.s('tts_rate',String(rate)),[rate]);
    React.useEffect(()=>S.s('tts_voiceURI',voiceId),[voiceId]);
    React.useEffect(()=>{try{S.s('tts_vocab',JSON.stringify(vocab))}catch{}},[vocab]);
    React.useEffect(()=>{try{S.s(K.ART,JSON.stringify(articles))}catch{}},[articles]);
    React.useEffect(()=>{S.s('ai_on',aiOn?'1':'0');S.s('ai_key',aiKey);S.s('ai_model',aiModel)},[aiOn,aiKey,aiModel]);

    // --- 載入語音 ---
    const loadVoices=React.useCallback(()=>{if(!supported)return;const list=window.speechSynthesis.getVoices();setVoices(list);if(!voiceId&&list[0]){const prefer=list.find(v=>/zh-TW/i.test(v.lang))||list.find(v=>/zh-CN/i.test(v.lang))||list.find(v=>/en-US/i.test(v.lang))||list[0];setVoiceId(prefer.voiceURI||prefer.name)}},[supported,voiceId]);
    React.useEffect(()=>{if(!supported)return;loadVoices();window.speechSynthesis.onvoiceschanged=loadVoices;return()=>{window.speechSynthesis.onvoiceschanged=null}},[supported,loadVoices]);
    const curVoice=voices.find(v=>(v.voiceURI||v.name)===voiceId)||null;

    const sessionRef=React.useRef(0); // 播放會話版本，避免競態插播
    const previewRef=React.useRef(null); // 預覽卷軸容器
    const rateTimerRef=React.useRef(null); // 調速防抖（可被 immediate 覆寫）
    const vocabQueueRef=React.useRef([]); // vocab 播放佇列
    const vocabIndexRef=React.useRef(0);  // 目前播放到佇列第幾項
    const vocabResumeRef=React.useRef(null); // 單字播放完是否要回到文章朗讀

    // --- TTS ---
    const cancelAll=()=>{if(!supported)return;sessionRef.current+=1;cancelRef.current=true;try{window.speechSynthesis.cancel()}catch{};modeRef.current='idle';setStatus('idle');setIdx(-1);charRef.current=0};
    const speakFrom=(start=0,offset=0)=>{
      if(!supported||!text.trim())return;
      const __sess__=sessionRef.current+1;sessionRef.current=__sess__;
      try{window.speechSynthesis.cancel()}catch{};cancelRef.current=false;modeRef.current='article';
      const say=(i,off)=>{
        if(sessionRef.current!==__sess__||i>=chunks.length){setStatus('idle');setIdx(-1);return}
        let t=String(chunks[i]||'');
        if(off>0){if(off>=t.length)return say(i+1,0);t=t.slice(off)}
        t=t.replace(/[“”"＂]/g,'');
        const u=new SpeechSynthesisUtterance(t);
        if(curVoice)u.voice=curVoice; u.rate=clamp(rate,K.RATE_MIN,K.ABS_MAX); u.pitch=1;
        u.onstart=()=>{ if(sessionRef.current!==__sess__) return; setStatus('speaking'); setIdx(i) };
        u.onboundary=(e)=>{ if(sessionRef.current!==__sess__) return; if(typeof e.charIndex==='number') charRef.current=(off||0)+e.charIndex };
        u.onend=()=>{ if(sessionRef.current!==__sess__) return; charRef.current=0; setTimeout(()=>{ if(sessionRef.current!==__sess__) return; say(i+1,0); },30) };
        u.onerror=u.onend; window.speechSynthesis.speak(u);
      };
      say(start,offset);
    };
    const speak=()=>speakFrom(0,0);
    const pause=()=>{if(!supported)return;try{window.speechSynthesis.pause()}catch{};setStatus('paused')};
    const resume=()=>{if(!supported)return;if(window.speechSynthesis.speaking){try{window.speechSynthesis.resume()}catch{};setStatus('speaking')}else{speakFrom(Math.max(idx,0),charRef.current||0)}};
    const stopAndRestart=()=>{ if(!supported)return;cancelAll();setTimeout(()=>speakFrom(0,0),10) };

    const changeRate=(r, immediate=false)=>{ const v=clamp(r,K.RATE_MIN,K.RATE_MAX); setRate(v);
      if(!supported) return;
      if(status==='speaking'){
        if(modeRef.current==='article'){
          if(rateTimerRef.current) clearTimeout(rateTimerRef.current);
          const curIdx=Math.max(idx,0); const curChar=charRef.current||0;
          if(immediate){
            speakFrom(curIdx,curChar);
          }else{
            rateTimerRef.current=setTimeout(()=>{ speakFrom(curIdx,curChar); },120);
          }
        } else if (modeRef.current==='vocab'){
          try{window.speechSynthesis.cancel()}catch{};
          speakVocabQueueFrom(Math.max(vocabIndexRef.current||0,0));
        }
      }
    };

    // --- 文章 ---
    const save=()=>{const now=new Date().toISOString();const t=(title||'').trim()||new Date().toLocaleString();if(!aid){const id=Date.now()+Math.random().toString(36).slice(2);setArticles(p=>[{id,title:t,content:text,vocab,createdAt:now,updatedAt:now},...p]);setAid(id);setTitle(t)}else{setArticles(p=>p.map(a=>a.id===aid?{...a,title:t,content:text,vocab,updatedAt:now}:a))}};
    const load=(id)=>{const a=articles.find(x=>x.id===id);if(!a)return;setAid(a.id);setTitle(a.title);setText(a.content||'');setVocab(Array.isArray(a.vocab)?a.vocab:[])};
    const del=(id)=>{setArticles(p=>p.filter(x=>x.id!==id));if(id===aid){setAid(null);setTitle('');setText('');setVocab([])}};
    const fresh=()=>{setAid(null);setTitle('');setText('');setVocab([])};

    // --- 單字 ---
    async function genDef(term){ if(aiOn&&aiKey){try{const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${aiKey}`},body:JSON.stringify({model:aiModel,temperature:.2,messages:[{role:'system',content:'You are a concise bilingual dictionary. Output exactly two lines: EN: <short gloss with POS> and ZH: <Traditional Chinese meaning>. Max 25 words each.'},{role:'user',content:`Define: ${term}`}]})});if(r.ok){const j=await r.json();const t=j?.choices?.[0]?.message?.content?.trim();if(t)return t}}catch(e){}}
      let en='';try{const r=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(term)}`);if(r.ok){const j=await r.json();const m=j?.[0]?.meanings?.[0];const d=m?.definitions?.[0]?.definition;en=(m?.partOfSpeech?`(${m.partOfSpeech}) `:'')+(d||'')}}catch{}
      let zh='';if(en){try{const r=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(en)}&langpair=en|zh-TW`);if(r.ok){const j=await r.json();zh=j?.responseData?.translatedText||''}}catch{}}
      return `${en?`EN: ${en}`:''}${en&&zh?'\n':''}${zh?`ZH: ${zh}`:''}`.trim()
    }
    async function addFromSelection(){const raw=sanitize(selText());if(!raw){setNote('請先在編輯框或預覽反白字詞');return}setNote('');setBusy(true);try{const def=await genDef(raw);setVocab(p=>{const has=p.some(x=>x.term.toLowerCase()===raw.toLowerCase());return has?p.map(x=>x.term.toLowerCase()===raw.toLowerCase()?{...x,definition:def||x.definition}:x):[{id:Date.now()+Math.random().toString(36).slice(2),term:raw,definition:def||''},...p]});save()}catch{setVocab(p=>[{id:Date.now()+Math.random().toString(36).slice(2),term:raw,definition:''},...p]);save()}finally{setBusy(false);setNote(`已加入：${raw}`)}}

    function speakVocabQueueFrom(start=0){
      if(!supported) return; const q=vocabQueueRef.current||[]; if(!q.length) return;
      const __sess__=sessionRef.current+1; sessionRef.current=__sess__;
      try{window.speechSynthesis.cancel()}catch{}; modeRef.current='vocab';
      const say=(i)=>{ if(sessionRef.current!==__sess__) return; if(i>=q.length){
          const resume=vocabResumeRef.current; vocabResumeRef.current=null;
          if(resume && resume.shouldResume){ speakFrom(Math.max(resume.idx,0), resume.char||0); }
          else { setStatus('idle'); setIdx(-1); }
          return; }
        const u=new SpeechSynthesisUtterance(String(q[i]||'')); if(curVoice) u.voice=curVoice; u.rate=clamp(rate,K.RATE_MIN,K.ABS_MAX); u.pitch=1;
        u.onstart=()=>{ if(sessionRef.current!==__sess__) return; setStatus('speaking'); setIdx(-1); vocabIndexRef.current=i; };
        u.onend=()=>{ if(sessionRef.current!==__sess__) return; setTimeout(()=>say(i+1),30); };
        u.onerror=u.onend; window.speechSynthesis.speak(u);
      };
      say(start);
    }

    const playAll=()=>{ if(!supported||!vocab.length) return; vocabResumeRef.current=null; const q=triple(vocab.map(it=>it.term),3); vocabQueueRef.current=q; speakVocabQueueFrom(0); };

    const speakWordOnce=(term)=>{ if(!supported||!term) return; const shouldResume=(status==='speaking'&&modeRef.current==='article'); vocabResumeRef.current = shouldResume ? {shouldResume:true, idx:idx, char:charRef.current||0} : null; vocabQueueRef.current=[term]; speakVocabQueueFrom(0); };

    const rm=(id)=>setVocab(p=>p.filter(x=>x.id!==id));

    // --- 衍生 ---
    const dur=(()=>{const w=(text.match(/\S+/g)||[]).length||0;const m=w/(160*Math.max(rate,K.RATE_MIN));const s=Math.ceil(m*60);return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`})();
    const glance=vocab.map(v=>({id:v.id,term:v.term,zh:parseZH(v.definition)}));

    // 朗讀時置中當前句（smooth）
    React.useEffect(()=>{
      if (idx < 0) return;
      const c = previewRef.current; if (!c) return;
      const el = c.querySelector('[data-active="true"]'); if (!el) return;
      const containerRect = c.getBoundingClientRect();
      const elRect = el.getBoundingClientRect();
      const current = c.scrollTop + (elRect.top - containerRect.top);
      const target = current - (c.clientHeight / 2 - el.clientHeight / 2);
      c.scrollTo({ top: Math.max(target, 0), behavior: 'smooth' });
    }, [idx, status, chunks.length]);

    return (
      <div className="max-w-6xl mx-auto p-5 text-slate-800">
        <h1 className="text-2xl md:text-3xl font-semibold mb-4">ReadBuddy｜朗讀夥伴</h1>
        {!supported&&<div className="p-3 mb-4 rounded-lg bg-red-50 text-red-700 border border-red-200">此瀏覽器不支援 SpeechSynthesis，建議用桌面版 Chrome/Edge。</div>}

        <div className="grid gap-4 md:grid-cols-3">
          {/* 左側：編輯、控制、預覽 */}
          <div className="md:col-span-2 space-y-4">
            <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
              <div className="grid gap-2 md:grid-cols-3 mb-2 items-center">
                <div className="md:col-span-2"><label className="text-sm">文章標題</label>
                  <input id="article-title" value={title} onChange={e=>setTitle(e.target.value)} placeholder="未命名文章"
                    className="w-full mt-1 rounded-xl border border-slate-300 p-2 bg-slate-50/50 focus:ring-2 focus:ring-indigo-400"/></div>
                <div className="flex gap-2 md:justify-end"><button onClick={save} className="px-3 py-2 rounded-xl bg-indigo-600 text-white">💾 儲存</button><button onClick={fresh} className="px-3 py-2 rounded-xl bg-slate-100">📝 新文章</button></div>
              </div>

              {/* 編輯框 */}
              <div className="flex items-center justify-between mb-1"><label htmlFor="tts-text" className="font-medium">文章Article</label><div className="text-xs text-slate-500">{text.length} 字 · 預估 {dur}</div></div>
              <textarea id="tts-text" value={text} onChange={e=>setText(e.target.value)} onDoubleClick={addFromSelection}
                onKeyDown={e=>{if(e.key==='Enter'){const ta=e.target;if(ta.selectionEnd>ta.selectionStart){e.preventDefault();addFromSelection()}}}}
                placeholder="貼上或輸入要朗讀的文字…（反白、雙擊或 Enter 可加入單字）"
                className="w-full h-40 md:h-44 rounded-xl border border-slate-300 focus:ring-2 focus:ring-indigo-400 p-3 bg-slate-50/50"/>

              {/* 控制列（置於預覽上方） */}
              <div className="flex items-center justify-between mt-3">
                <div className="flex gap-2">
                  <button onClick={speak} disabled={!supported||!text.trim()} className="px-4 py-2 rounded-xl bg-indigo-600 text-white disabled:opacity-40">▶️ 朗讀</button>
                  {status==='speaking'? <button onClick={pause} className="px-4 py-2 rounded-xl bg-slate-100">⏸ 暫停</button>
                   : status==='paused'? <button onClick={resume} className="px-4 py-2 rounded-xl bg-slate-100">⏯ 繼續</button>
                   : <button disabled className="px-4 py-2 rounded-xl bg-slate-50 text-slate-400 border">⏸ 暫停</button>}
                  <button onClick={stopAndRestart} className="px-4 py-2 rounded-xl bg-slate-100">⏹ 停止（重頭）</button>
                </div>
                <div className="text-xs text-slate-500">{idx>=0?`進度：${idx+1}/${chunks.length}`:`段落：${chunks.length}`}</div>
              </div>

              {/* 預覽（同步高亮、點段落播放；雙擊選字加入） */}
              <div className="mt-2">
                <div className="flex items-center justify-between mb-1"><h2 className="font-medium">逐句跟讀Read by sentence</h2><div className="text-xs text-slate-500">{idx>=0?`${idx+1}/${chunks.length}`:`${chunks.length} 段`}</div></div>
                <div ref={previewRef} className="max-h-64 overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 space-y-2" tabIndex={0}
                  onKeyDown={e=>{if(e.key==='Enter'){const s=(window.getSelection&&window.getSelection().toString().trim());if(s){e.preventDefault();addFromSelection()}}}}>
                  {chunks.length===0&&<div className="text-sm text-slate-500">無文字。</div>}
                  {chunks.map((c,i)=>{const active=i===idx&&(status==='speaking'||status==='paused');return (
                    <div key={i} data-active={active ? 'true' : 'false'} className={`text-sm leading-relaxed rounded-lg border p-2 select-text ${active?'bg-yellow-50 border-yellow-300 ring-2 ring-yellow-200':'bg-white border-slate-200 hover:bg-slate-50'}`}
                      title={active?'正在朗讀；雙擊選字加入，或點此段重播':'雙擊選字加入；點擊此段播放'}
                      onClick={e=>{if((window.getSelection&&window.getSelection().toString().trim()))return; speakFrom(i,0);}}
                      onDoubleClick={e=>{e.preventDefault();addFromSelection()}}>
                      <span className="opacity-60 mr-2">[{i+1}]</span><span>{c}</span>
                    </div>)})}
                </div>
                {note&&<div className="mt-2 text-xs text-emerald-700 bg-emerald-50 border border-emerald-200 rounded px-2 py-1">{note}</div>}
              </div>
            </div>
          </div>

          {/* 右側：文章清單、語音、語速、單字速覽、AI 設定 */}
          <div className="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 space-y-4">
            {/* 我的文章（移到右側） */}
            <div>
              <div className="flex items-center justify-between mb-1"><h3 className="text-sm font-medium">我的文章</h3><span className="text-xs text-slate-500">{articles.length} 篇</span></div>
              <div className="max-h-32 overflow-auto rounded-xl border border-slate-200 divide-y bg-white">
                {articles.length===0? <div className="p-3 text-sm text-slate-500">尚未儲存文章。</div> : articles.map(a=> (
                  <div key={a.id} className={`p-2 flex items-center gap-2 ${a.id===aid?'bg-indigo-50':''}`}>
                    <button className="flex-1 text-left truncate" onClick={()=>load(a.id)} title={new Date(a.updatedAt).toLocaleString()}>
                      <div className="truncate font-medium">{a.title}</div>
                      <div className="text-xs text-slate-500">更新：{new Date(a.updatedAt).toLocaleString()}</div>
                    </button>
                    <button onClick={()=>del(a.id)} className="px-2 py-1 text-xs rounded bg-red-50 text-red-700 border border-red-200">刪除</button>
                  </div>))}
              </div>
            </div>

            {/* 語音＋語速（灰底） */}
            <div className="rounded-xl bg-slate-50 p-3 space-y-4">
              <div>
                <label className="block font-medium mb-1">語音</label>
                <select value={voiceId} onChange={e=>setVoiceId(e.target.value)} className="w-full rounded-xl border border-slate-300 p-2 focus:ring-2 focus:ring-indigo-400">
                  {voices.length===0&&<option>（載入中…）</option>}
                  {voices.map(v=> <option key={v.voiceURI||v.name} value={v.voiceURI||v.name}>{v.name} — {v.lang}</option>)}
                </select>
                {curVoice&&<div className="mt-1 text-xs text-slate-500">目前：{curVoice.name}（{curVoice.lang}）</div>}
              </div>
              <div>
                <label className="block font-medium mb-1">語速（{rate.toFixed(2)}×）</label>
                <input type="range" min={K.RATE_MIN} max={K.RATE_MAX} step={0.25} value={rate} onInput={e=>changeRate(parseFloat(e.target.value), true)} onChange={e=>changeRate(parseFloat(e.target.value), true)} className="w-full"/>
                <div className="flex justify-between text-xs text-slate-500"><span>更慢（{K.RATE_MIN}×）</span><span>更快（{K.RATE_MAX}×）</span></div>
                <div className="flex flex-wrap items-center gap-2 mt-2 text-xs">
                  {[.25,.5,.75,1].map(v=> <button type="button" key={v} onClick={()=>changeRate(v, true)} className="px-2 py-1 rounded bg-slate-100">{v===.25?'超慢 ':''}{v}×</button>)}
                  <span className="text-slate-500">（雙點擊）</span>
                </div>
              </div>
            </div>

            {/* 單字速覽（僅顯示 英文 / 中文同義詞） */}
            <div className="pt-2 border-t border-slate-200">
              <div className="mb-2">
                <h3 className="font-medium">單字速覽</h3>
                <div className="flex gap-2 text-sm mt-2">
                  <button onClick={addFromSelection} disabled={busy} className="px-3 py-1.5 rounded-full bg-emerald-600 text-white disabled:opacity-50">{busy?'⏳ 解析中…':'🤖 從選取新增'}</button>
                  <button onClick={playAll} className="px-3 py-1.5 rounded-full bg-indigo-600 text-white">▶️ 單字播放 x 3</button>
                </div>
              </div>
              {glance.length===0? <div className="text-sm text-slate-500">尚未加入單字。雙擊文章中的字詞可加入。</div> :
                <div className="max-h-60 overflow-auto md:max-h-none md:overflow-visible rounded-xl border border-slate-200 divide-y">
                  {glance.map(g=> (
                    <div key={g.id} className="flex items-center gap-2 p-2">
                      <div className="flex-1 min-w-0">
                        <button type="button" onClick={()=>speakWordOnce(g.term)} className="font-semibold truncate text-left cursor-pointer hover:underline text-blue-800 hover:text-blue-900" title="點擊播放 1 次">{g.term}</button>
                        {g.zh&&<div className="text-xs text-slate-500 truncate">{g.zh}</div>}
                      </div>
                      <button onClick={()=>rm(g.id)} className="px-2 py-1 text-xs rounded bg-red-50 text-red-700 border border-red-200">刪</button>
                    </div>))}
                </div>
              }
            </div>

            {/* AI 設定（可選） */}
            <details className="rounded-xl bg-slate-50 p-3">
              <summary className="cursor-pointer select-none font-medium">AI 設定（可選）</summary>
              <div className="mt-3 space-y-2 text-sm">
                <label className="block">是否使用 OpenAI
                  <select value={aiOn? '1':'0'} onChange={e=>setAiOn(e.target.value==='1')} className="mt-1 w-full rounded border p-1">
                    <option value="0">不使用（僅字典備援）</option>
                    <option value="1">使用 OpenAI（需 API Key）</option>
                  </select>
                </label>
                {aiOn&&<>
                  <label className="block">API Key
                    <input type="password" value={aiKey} onChange={e=>setAiKey(e.target.value)} placeholder="sk-..." className="mt-1 w-full rounded border p-1"/>
                  </label>
                  <label className="block">Model
                    <input value={aiModel} onChange={e=>setAiModel(e.target.value)} className="mt-1 w-full rounded border p-1"/>
                  </label>
                  <div className="text-[11px] text-slate-500">提醒：前端存 Key 有風險，僅供個人使用；上線請改後端代理。</div>
                </>}
              </div>
            </details>
          </div>
        </div>

        <footer className="py-6 text-center text-xs text-slate-400">
          <div>© {new Date().getFullYear()} ReadBuddy｜朗讀夥伴</div>
          <a href="/privacy.html" className="underline text-slate-500 hover:text-slate-700">Privacy Policy｜隱私權政策</a>
        </footer>
      </div>
    );
  }

  const root=ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App/>);
  </script>
</body>
</html>
